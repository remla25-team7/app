name: Release
on:
  push:
#    branches:
#      - main
    tags:
      - v*


env:
  REGISTRY: ghcr.io
  IMAGE_NAME_FRONTEND: app-frontend
  IMAGE_NAME_SERVICE: app-service

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
    - uses: actions/checkout@v4

    - uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GH_TOKEN }}

    - name: Build and push Docker image
      run: |
        # Convert repository to lowercase for image name
        IMG="ghcr.io/${{github.repository}}"
        IMG=${IMG@L}
        
        # Always build and push as latest
        docker build -t $IMG:latest .
        docker push $IMG:latest
        
        # If this is a tag push, also tag with the version
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
          docker tag $IMG:latest $IMG:$VERSION
          docker push $IMG:$VERSION
        fi